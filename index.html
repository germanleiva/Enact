<!DOCTYPE html>
<html>

<head>
    <title>Enact</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.3.1/css/bulma.min.css">
    <link rel="stylesheet" type="text/css" href="index.css">
</head>

<body>
    <div id="toolbar">
        <div class="block">
            <a class="button" :class="{'is-active':selectionMode}" v-on:click="selectionSelected">Selection</a>
            <a class="button" :class="{'is-active':drawMode}" v-on:click="drawSelected">Draw</a>
            <a class="button">Measure</a>
            <a class="button" v-on:click="changeToBlue">Change to blue</a>
            <a class="button" v-on:click="changeToRed">Change to red</a>
            <a class="button" v-on:click="addVisualOuput">Add VisualState</a>
        </div>
    </div>
    <div id="outputArea" class="outputArea">
    </div>
    <!--     <div id="drawingArea" v-on:mousedown="actionStarted" style="background-color:red; height: 500px">
    </div> -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script>
    window.addEventListener('keydown',function(e){
        e.preventDefault();
        if (e.code === 'AltLeft' || e.code === 'AltRight') {
            toolbarVM.multiSelectionMode = true;
        }
    });
    window.addEventListener('keyup',function(e){
        e.preventDefault();
        toolbarVM.multiSelectionMode = false;
    });

    var VisualOuput = Vue.extend({
        template: '<div v-on:mousedown="actionStarted" class="visualState"></div>',
        data: function() {
            return {
                shapes: [],
                startingPosition: {
                    x: 0,
                    y: 0
                }
            }
        },
        methods: {
            selectedShapes: function() {
                return this.shapes.filter(function(each) {
                    return each.isSelected;
                });
            },
            actionStarted: function(e) {
                if (toolbarVM.drawMode) {
                    this.drawingStarted(e);
                }
                if (toolbarVM.selectionMode) {
                    //We traverse the shapes in backward order
                    var selectedShape = null;
                    for (var i = this.shapes.length - 1; i >= 0; i--) {
                        var each = this.shapes[i];
                        if (each.isPointInside(e.x, e.y)) {
                            each.toggleSelection();
                            if (each.isSelected) {
                                selectedShape = each;
                            }
                            this.moveStarted(e, each);
                            continue;
                        }
                    }

                    if (!toolbarVM.multiSelectionMode) {
                        _.each(this.selectedShapes(),function(previouslySelectedShape) {
                            if (previouslySelectedShape !== selectedShape) {
                                previouslySelectedShape.deselect();
                            }
                        });
                    }
                }
            },

            //DRAWING METHODS
            drawingStarted: function(e) {
                var newDiv = new Shape().$mount()
                this.$el.appendChild(newDiv.$el)

                this.$el.addEventListener('mousemove', this.drawingChanged, false);
                this.$el.addEventListener('mouseup', this.drawingEnded, false);

                newDiv.startingPosition.x = e.x;
                newDiv.startingPosition.y = e.y;
                this.shapes.push(newDiv);

                this.updateDrawnDivStyle(e, newDiv);
            },

            drawingChanged: function(e) {
                this.updateDrawnDivStyle(e, this.shapes[this.shapes.length - 1]);
            },

            drawingEnded: function(e) {
                this.$el.removeEventListener('mousemove', this.drawingChanged, false);
                this.$el.removeEventListener('mouseup', this.drawingEnded, false);
            },

            updateDrawnDivStyle: function(e, drawnDiv) {
                var topValue = drawnDiv.startingPosition.y
                if (e.y < drawnDiv.startingPosition.y) {
                    topValue = e.y;
                }

                var leftValue = drawnDiv.startingPosition.x
                if (e.x < drawnDiv.startingPosition.x) {
                    leftValue = e.x;
                }
                var widthValue = Math.abs(e.x - drawnDiv.startingPosition.x);
                var heightValue = Math.abs(e.y - drawnDiv.startingPosition.y)

                drawnDiv.topValue = topValue;
                drawnDiv.leftValue = leftValue;
                drawnDiv.widthValue = widthValue;
                drawnDiv.heightValue = heightValue;
            },


            //MOVING METHODS
            moveStarted: function(e, selectedDrawing) {
                var offsetX = e.x - selectedDrawing.leftValue;
                var offsetY = e.y - selectedDrawing.topValue;

                var parentElement = selectedDrawing.$el.parentNode;
                //When the second parameter is null in insertBefore the element is added as the last child
                parentElement.insertBefore(selectedDrawing.$el, null);

                var moveHanlder = function(e) {
                    this.moveChanged(e, selectedDrawing, offsetX, offsetY);
                }.bind(this);
                this.$el.addEventListener('mousemove', moveHanlder, false);
                var upHandler = function(e) {
                    this.$el.removeEventListener('mousemove', moveHanlder, false);
                    this.$el.removeEventListener('mouseup', this, false);
                }.bind(this);
                this.$el.addEventListener('mouseup', upHandler, false);
            },

            moveChanged: function(e, selectedDrawing, initialOffsetX, initialOffsetY) {
                selectedDrawing.topValue = Math.abs(initialOffsetY - e.y);
                selectedDrawing.leftValue = Math.abs(initialOffsetX - e.x);
            },
            propertyChanged: function(cssStyle) {
                _.each(this.selectedShapes(),function(shape){
                    shape.color = cssStyle['background-color'];
                });
            }
        }
    });

    // create a new Vue instance and mount it to our div element above with the id of app
    var outputAreaVM = new Vue({
        el: '#outputArea',
        data: {
            visualOutputs:[]
        },
        methods: {
            propertyChangedOnSelectedShape: function(cssStyle) {
                _.each(this.visualOutputs,function(each){
                    each.propertyChanged(cssStyle);
                });
            }
        }
    });

    var Shape = Vue.extend({
        template: "<div v-bind:style='styleObject'></div>",
        data: function() {
            return {
                color: 'white',
                isSelected: false,
                startingPosition: {
                    x: 0,
                    y: 0
                },
                topValue: 0,
                leftValue: 0,
                widthValue: 0,
                heightValue: 0
            }
        },
        computed: {
            styleObject: function() {
                return {
                    'backgroundColor': this.color,
                    'position': 'absolute',
                    'top': this.topValue + 'px',
                    'left': this.leftValue + 'px',
                    'width': this.widthValue + 'px',
                    'height': this.heightValue + 'px',
                    'border': (this.isSelected ? '4px':'1px') + ' solid gray'
                }
            }
        },
        methods: {
            isPointInside: function(x, y) {
                return this.topValue < y && this.leftValue < x && x < this.leftValue + this.widthValue && y < this.topValue + this.heightValue;

            },
            toggleSelection() {
                this.isSelected = !this.isSelected;
            },
            deselect() {
                if (this.isSelected) {
                    this.isSelected = false;
                }
            }
        }
    });

    var toolbarVM = new Vue({
        el: '#toolbar',
        data: {
            drawMode: false,
            selectionMode: true,
            multiSelectionMode:false
        },
        methods: {
            drawSelected() {
                this.drawMode = true;
                this.selectionMode = false;
            },

            selectionSelected() {
                this.drawMode = false;
                this.selectionMode = true;
            },
            changeToBlue() {
                outputAreaVM.propertyChangedOnSelectedShape({'background-color':'blue'});
            },
            changeToRed() {
                outputAreaVM.propertyChangedOnSelectedShape({'background-color':'red'});
            },

            addVisualOuput() {
                var newVisualOuput = new VisualOuput().$mount()
                outputAreaVM.$el.appendChild(newVisualOuput.$el)

                outputAreaVM.$data.visualOutputs.push(newVisualOuput);
            }
        }
    });
    </script>
</body>

</html>
